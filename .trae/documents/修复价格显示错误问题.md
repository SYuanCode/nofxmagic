## 修复方案

### 问题分析
1. **AI提示词中的当前价格不正确**：
   - 原因：当前价格从3分钟K线的最后一根收盘价获取，可能不是最新价格
   - 影响：AI基于错误价格做出判断，可能导致错误决策

2. **TG推送开仓价格错误**：
   - 原因：TG推送使用的是开仓前获取的价格，而非交易所实际成交价格
   - 影响：用户看到的开仓价格与实际不符，造成混淆

### 修复计划

#### 1. 修复AI提示词中的当前价格问题
   - **文件**：`trader/binance_futures.go`
   - **修改点**：在`OpenLong`和`OpenShort`函数中，返回实际成交价格
   - **实现**：
     - 从交易所返回的订单信息中提取实际成交价格
     - 如果订单信息中没有成交价格，则重新获取最新市场价格

#### 2. 修复TG推送开仓价格错误问题
   - **文件**：`trader/auto_trader.go`
   - **修改点**：
     - 在`executeOpenLongWithRecord`和`executeOpenShortWithRecord`函数中，使用实际成交价格发送TG通知
     - 开仓后获取实际成交价格，替代开仓前获取的价格

#### 3. 优化市场价格获取机制
   - **文件**：`market/data.go`
   - **修改点**：
     - 确保`GetCurrentKlines`返回最新的K线数据
     - 考虑添加价格验证，确保获取的价格合理

### 技术实现细节

1. **修改`OpenLong`和`OpenShort`函数**：
   ```go
   // 计算实际成交价格
   executedQty, _ := strconv.ParseFloat(order.ExecutedQty, 64)
   cumQuote, _ := strconv.ParseFloat(order.CumQuote, 64)
   if executedQty > 0 && cumQuote > 0 {
       actualPrice := cumQuote / executedQty
       result["price"] = actualPrice
   }
   ```

2. **修改TG推送逻辑**：
   ```go
   // 获取实际成交价格
   var actualPrice float64
   if price, ok := order["price"].(float64); ok {
       actualPrice = price
   } else {
       // 如果没有实际成交价格，使用最新市场价格
       marketData, err := market.Get(decision.Symbol)
       if err != nil {
           log.Printf("  ⚠ 获取实际成交价格失败: %v", err)
       } else {
           actualPrice = marketData.CurrentPrice
       }
   }
   ```

3. **修改TG消息模板**：
   ```go
   tgMessage := fmt.Sprintf("📉 **开空仓成功**\n"+
       "📋 币种: `%s`\n"+
       "💰 仓位大小: `%.2f USDT`\n"+
       "📊 成交价格: `%.4f`\n"+
       "⚙️ 杠杆: `%dx`\n"+
       "🛑 止损: `%.4f`\n"+
       "🎯 止盈: `%.4f`\n"+
       "📝 订单ID: `%v`\n"+
       "⏰ 时间: `%s`",
       decision.Symbol,
       decision.PositionSizeUSD,
       actualPrice, // 使用实际成交价格
       decision.Leverage,
       decision.StopLoss,
       decision.TakeProfit,
       order["orderId"],
       time.Now().Format("2006-01-02 15:04:05"))
   ```

### 预期效果
1. AI提示词将使用最新的市场价格，提高决策准确性
2. TG推送将显示实际成交价格，与交易所记录一致
3. 增强系统的可靠性和用户体验
4. 减少因价格误差导致的交易错误

### 验证方法
1. 运行系统，观察AI提示词中的当前价格是否与实际市场价格一致
2. 执行开仓操作，检查TG推送的价格是否与交易所实际成交价格一致
3. 检查日志，确认没有价格相关的错误

### 依赖关系
- 无需引入新的依赖
- 只修改现有代码，确保兼容性
- 遵循现有代码风格和架构

### 风险评估
- 低风险：修改范围小，只涉及价格获取和显示
- 向后兼容：不影响现有功能
- 性能影响：可忽略，仅增加少量API调用

### 实施步骤
1. 修改`trader/binance_futures.go`，使开仓函数返回实际成交价格
2. 修改`trader/auto_trader.go`，使用实际成交价格发送TG通知
3. 测试修复效果
4. 部署到生产环境